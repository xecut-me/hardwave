<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Telegram Updates</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
      padding-right: 40px;
    }
    .welcome {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      font-size: 50px;
      text-align: center;
    }
    .photo-view {
      display: none;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      flex-shrink: 0;
    }
    .sender {
      font-size: 50px;
      font-weight: bold;
    }
    .bot-name {
      font-size: 50px;
    }
    .image-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .image-container img,
    .image-container video {
      width: 100%;
      height: 100%;
      object-fit: fill;
    }
    .image-container.keep-aspect img,
    .image-container.keep-aspect video {
      object-fit: contain;
    }
    #video {
      display: none;
    }
    .photo-view {
      cursor: none;
    }
  </style>
</head>
<body>
  <div class="welcome" id="welcome">send media in @xexecut_chat</div>

  <div class="photo-view" id="photoView">
    <div class="header">
      <div class="sender" id="sender"></div>
      <div class="bot-name">send media in @xexecut_chat</div>
    </div>
    <div class="image-container">
      <img id="photo" src="" alt="Photo">
      <video id="video" src="" autoplay loop muted playsinline></video>
    </div>
  </div>

  <script>
    (function() {
      console.log('[INIT] Starting Telegram Updates viewer');

      const params = new URLSearchParams(window.location.search);
      const queryKey = params.get('api_key');
      const keepAspectRatio = params.get('respect_aspect_ratio') === '1' || params.get('respect_aspect_ratio') === 'true';
      const allowedChatId = params.get('chat_id') || null;

      console.log('[CONFIG] URL parameters:', {
        hasApiKey: !!queryKey,
        keepAspectRatio,
        allowedChatId
      });

      if (!queryKey) {
        console.error('[CONFIG] No API key found in URL - aborting');
        document.body.innerHTML = '<div class="welcome">api_key not found in URL</div>';
        return;
      }

      if (!allowedChatId) {
        console.error('[CONFIG] No chat_id found in URL - aborting');
        document.body.innerHTML = '<div class="welcome">chat_id not found in URL</div>';
        return;
      }

      const apiKey = queryKey;
      console.log('[CONFIG] API key loaded from URL');

      const welcomeEl = document.getElementById('welcome');
      const photoViewEl = document.getElementById('photoView');
      const senderEl = document.getElementById('sender');
      const photoEl = document.getElementById('photo');
      const videoEl = document.getElementById('video');
      const imageContainerEl = document.querySelector('.image-container');

      if (keepAspectRatio) {
        imageContainerEl.classList.add('keep-aspect');
      }

      let offset = 0;

      function displayUpdate(update) {
        console.log('[DISPLAY] Processing update:', { update_id: update.update_id });
        console.log('[DISPLAY] Full JSON:', JSON.stringify(update, null, 2));

        const message = update.message;
        if (!message) {
          console.log('[DISPLAY] Skipping update - no message field present');
          return;
        }

        console.log('[DISPLAY] Message received:', {
          message_id: message.message_id,
          chat_id: message.chat.id,
          from: message.from.first_name,
          has_photo: !!(message.photo && message.photo.length > 0),
          has_video: !!message.video
        });

        // Filter by chat_id if specified
        if (allowedChatId && String(message.chat.id) !== allowedChatId) {
          console.log('[DISPLAY] Skipping message - chat_id filter mismatch:', {
            expected: allowedChatId,
            actual: message.chat.id
          });
          return;
        }

        // Filter out users without username
        if (!message.from.username) {
          console.log('[DISPLAY] Skipping message - user has no username:', {
            from: message.from.first_name,
            user_id: message.from.id
          });
          return;
        }

        // Filter out spoilered content
        if (message.has_media_spoiler) {
          console.log('[DISPLAY] Skipping message - has media spoiler:', {
            from: message.from.first_name,
            message_id: message.message_id
          });
          return;
        }

        const sender = message.from.first_name + (message.from.username ? ' @' + message.from.username : '');
        let fileId = null;
        let isVideo = false;

        if (message.photo && message.photo.length > 0) {
          fileId = message.photo[message.photo.length - 1].file_id;
          isVideo = false;
          console.log('[DISPLAY] Detected PHOTO, using largest size:', {
            photo_sizes_count: message.photo.length,
            selected_file_id: fileId
          });
        } else if (message.animation) {
          fileId = message.animation.file_id;
          isVideo = true;
          console.log('[DISPLAY] Detected GIF/ANIMATION:', { file_id: fileId });
        } else if (message.video) {
          fileId = message.video.file_id;
          isVideo = true;
          console.log('[DISPLAY] Detected VIDEO:', { file_id: fileId });
        }

        if (!fileId) {
          console.log('[DISPLAY] Message has no photo, video, or animation - ignoring');
        }

        if (fileId) {
          console.log('[DISPLAY] Fetching file from Telegram API...');
          fetch(`https://api.telegram.org/bot${apiKey}/getFile?file_id=${fileId}`)
            .then(res => res.json())
            .then(data => {
              if (data.ok) {
                const fileUrl = `https://api.telegram.org/file/bot${apiKey}/${data.result.file_path}`;
                console.log('[DISPLAY] File fetched successfully:', {
                  file_path: data.result.file_path,
                  isVideo
                });

                welcomeEl.style.display = 'none';
                photoViewEl.style.display = 'flex';
                senderEl.textContent = sender;

                if (isVideo) {
                  console.log('[DISPLAY] Rendering as VIDEO element');
                  photoEl.style.display = 'none';
                  photoEl.src = '';
                  videoEl.style.display = 'block';
                  videoEl.src = fileUrl;
                } else {
                  console.log('[DISPLAY] Rendering as IMG element');
                  videoEl.pause();
                  videoEl.src = '';
                  videoEl.style.display = 'none';
                  photoEl.style.display = 'block';
                  photoEl.src = fileUrl;
                }
              } else {
                console.error('[DISPLAY] Telegram API error:', data);
              }
            })
            .catch(err => {
              console.error('[DISPLAY] Failed to fetch file:', err);
            });
        }
      }

      async function pollUpdates() {
        console.log('[POLL] Starting long-poll request with offset:', offset);
        try {
          const url = `https://api.telegram.org/bot${apiKey}/getUpdates?offset=${offset}&timeout=30`;
          const res = await fetch(url);
          const data = await res.json();

          if (data.ok && data.result.length > 0) {
            console.log('[POLL] Received', data.result.length, 'update(s)');
            for (const update of data.result) {
              console.log('[POLL] Processing update_id:', update.update_id);
              displayUpdate(update);
              offset = update.update_id + 1;
              console.log('[POLL] Updated offset to:', offset);
            }
          } else if (data.ok) {
            console.log('[POLL] No new updates (timeout reached)');
          } else {
            console.error('[POLL] API returned error:', data);
          }
        } catch (e) {
          console.error('[POLL] Polling error:', e);
        }

        console.log('[POLL] Scheduling next poll...');
        pollUpdates();
      }

      console.log('[INIT] Starting polling loop');
      pollUpdates();
    })();
  </script>
</body>
</html>
