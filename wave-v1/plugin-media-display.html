<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>HardWave Display Plugin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background: #000;
      color: #fff;
      overflow: hidden;
    }
    .welcome {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      font-size: 50px;
      text-align: center;
    }
    .photo-view {
      display: none;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      flex-shrink: 0;
    }
    .sender {
      font-size: 50px;
      font-weight: bold;
    }
    .bot-name {
      font-size: 50px;
    }
    .image-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .image-container img,
    .image-container video {
      width: 100%;
      height: 100%;
      object-fit: fill;
    }
    .image-container.keep-aspect img,
    .image-container.keep-aspect video {
      object-fit: contain;
    }
    #video {
      display: none;
    }

    .key-display-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      z-index: 9999;
    }
    .key-display-text {
      font-size: 40vw;
      font-weight: bold;
      color: red;
      -webkit-text-stroke: 8px blue;
      text-stroke: 8px blue;
      paint-order: stroke fill;
      opacity: 0;
      transform: scale(1);
      transition: none;
    }
    .key-display-text.visible {
      opacity: 1;
      transform: scale(1);
    }
    .key-display-text.fading {
      opacity: 0;
      transform: scale(1.5);
      transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    }
  </style>
</head>
<body>
  <div class="key-display-overlay"><div class="key-display-text" id="keyDisplay"></div></div>
  <div class="welcome" id="welcome">Loading...</div>

  <div class="photo-view" id="photoView">
    <div class="header">
      <div class="sender" id="sender"></div>
      <div class="bot-name" id="botName"></div>
    </div>
    <div class="image-container" id="imageContainer">
      <img id="photo" src="" alt="Photo">
      <video id="video" src="" autoplay loop muted playsinline></video>
    </div>
  </div>

  <script>
    // ============================================================
    // CONFIG
    // ============================================================
    const CONFIG = {
      KEY_DISPLAY_DURATION_MS: 1000,
      KEY_FADE_DURATION_MS: 800,
      RANDOM_PACKAGE_COUNT: 100,
      RANDOM_DIGIT_MAX: 128,
      RANDOM_SYMBOLS_MAX: 4096,
    };

    // ============================================================
    // State
    // ============================================================
    let chatName = '';
    let displayEnabled = true;

    // ============================================================
    // DOM Elements
    // ============================================================
    const welcomeEl = document.getElementById('welcome');
    const botNameEl = document.getElementById('botName');
    const photoViewEl = document.getElementById('photoView');
    const senderEl = document.getElementById('sender');
    const photoEl = document.getElementById('photo');
    const videoEl = document.getElementById('video');
    const imageContainerEl = document.getElementById('imageContainer');
    const keyDisplayEl = document.getElementById('keyDisplay');

    // ============================================================
    // Key Display Handler
    // ============================================================
    const KeyDisplay = (function() {
      let fadeTimeout = null;
      let removeTimeout = null;

      const specialKeys = {
        'Enter': 'Enter',
        'Escape': 'Esc'
      };

      function getKeyName(key) {
        if (specialKeys[key]) return specialKeys[key];
        if (key.startsWith('F') && key.length <= 3) return key;
        if (key.length === 1) return key.toUpperCase();
        return key;
      }

      function show(key) {
        if (fadeTimeout) clearTimeout(fadeTimeout);
        if (removeTimeout) clearTimeout(removeTimeout);

        const keyName = getKeyName(key);
        keyDisplayEl.classList.remove('fading');
        keyDisplayEl.classList.remove('visible');
        keyDisplayEl.textContent = keyName;

        void keyDisplayEl.offsetWidth;

        keyDisplayEl.classList.add('visible');

        fadeTimeout = setTimeout(() => {
          keyDisplayEl.classList.add('fading');
          keyDisplayEl.classList.remove('visible');

          removeTimeout = setTimeout(() => {
            keyDisplayEl.classList.remove('fading');
          }, CONFIG.KEY_FADE_DURATION_MS);
        }, CONFIG.KEY_DISPLAY_DURATION_MS);

        // Handle Enter key for aspect ratio toggle
        if (key === 'Enter') {
          imageContainerEl.classList.toggle('keep-aspect');
        }
      }

      return { show };
    })();

    // ============================================================
    // Media Renderer
    // ============================================================
    function showWelcome() {
      videoEl.pause();
      videoEl.src = '';
      videoEl.style.display = 'none';
      photoEl.src = '';
      photoEl.style.display = 'none';
      photoViewEl.style.display = 'none';
      welcomeEl.style.display = 'flex';
      welcomeEl.textContent = 'send media in ' + chatName;
    }

    function showPlaceholder() {
      videoEl.pause();
      videoEl.src = '';
      videoEl.style.display = 'none';
      photoEl.src = '';
      photoEl.style.display = 'none';
      photoViewEl.style.display = 'none';
      welcomeEl.style.display = 'flex';
      welcomeEl.textContent = 'display is off';
    }

    function showError(message) {
      welcomeEl.textContent = message;
    }

    function showMedia(url, isVideo, sender) {
      welcomeEl.style.display = 'none';
      photoViewEl.style.display = 'flex';
      senderEl.textContent = sender;

      if (isVideo) {
        photoEl.style.display = 'none';
        photoEl.src = '';
        videoEl.style.display = 'block';
        videoEl.src = url;
      } else {
        videoEl.pause();
        videoEl.src = '';
        videoEl.style.display = 'none';
        photoEl.style.display = 'block';
        photoEl.src = url;
      }
    }

    // ============================================================
    // HID Commands (via parent)
    // ============================================================
    function sendHidCommand(command, data) {
      const msg = { type: 'hid', command, ...data };
      window.parent.postMessage(msg, '*');
    }

    function sendReaction(chatId, messageId, emoji) {
      window.parent.postMessage({ type: 'reaction', chatId, messageId, emoji }, '*');
    }

    async function handleDisplayCommand(text, chatId, messageId) {
      const displayText = text.substring(9); // Remove '/display '
      console.log('[Plugin] /display command:', displayText);
      sendHidCommand('runningText', { text: displayText });
      // Reaction will be sent based on hidResult
    }

    async function handleRandomCommand(chatId, messageId) {
      console.log('[Plugin] /random command - sending packages');
      for (let i = 0; i < CONFIG.RANDOM_PACKAGE_COUNT; i++) {
        const randomDigits = [
          Math.floor(Math.random() * CONFIG.RANDOM_DIGIT_MAX),
          Math.floor(Math.random() * CONFIG.RANDOM_DIGIT_MAX),
          Math.floor(Math.random() * CONFIG.RANDOM_DIGIT_MAX),
          Math.floor(Math.random() * CONFIG.RANDOM_DIGIT_MAX)
        ];
        const randomSymbols = Math.floor(Math.random() * CONFIG.RANDOM_SYMBOLS_MAX);
        sendHidCommand('raw', { digits: randomDigits, symbols: randomSymbols });
      }
      sendReaction(chatId, messageId, 'ðŸ‘€');
    }

    // ============================================================
    // Message Handler from Parent
    // ============================================================
    let pendingReaction = null;

    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (!msg || !msg.type) return;

      console.log('[Plugin] Received message:', msg.type);

      switch (msg.type) {
        case 'init':
          chatName = msg.chatName || '';
          botNameEl.textContent = 'send media in ' + chatName;
          if (msg.keepAspectRatio) {
            imageContainerEl.classList.add('keep-aspect');
          }
          if (displayEnabled) {
            showWelcome();
          }
          break;

        case 'error':
          showError(msg.message);
          break;

        case 'displayOn':
          displayEnabled = true;
          showWelcome();
          break;

        case 'displayOff':
          displayEnabled = false;
          showPlaceholder();
          break;

        case 'keypress':
          KeyDisplay.show(msg.key);
          break;

        case 'media':
          if (displayEnabled) {
            if (msg.videoUrl) {
              showMedia(msg.videoUrl, true, msg.sender);
            } else if (msg.photoUrl) {
              showMedia(msg.photoUrl, false, msg.sender);
            }
          }
          break;

        case 'command':
          if (msg.text.startsWith('/display ')) {
            pendingReaction = { chatId: msg.chatId, messageId: msg.messageId };
            handleDisplayCommand(msg.text, msg.chatId, msg.messageId);
          } else if (msg.text === '/random') {
            handleRandomCommand(msg.chatId, msg.messageId);
          }
          break;

        case 'hidResult':
          if (msg.command === 'runningText' && pendingReaction) {
            sendReaction(pendingReaction.chatId, pendingReaction.messageId, msg.success ? 'ðŸ‘€' : 'ðŸ‘Ž');
            pendingReaction = null;
          }
          break;
      }
    });

    // Initial state
    welcomeEl.textContent = 'Loading...';
  </script>
</body>
</html>
